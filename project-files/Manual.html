<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>マニュアル</title>
<style>
  body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; padding:16px; }
  h1 { font-size:18px; margin:0 0 12px; }
  h2 { font-size:15px; margin:16px 0 8px; }
  .card { border:1px solid #ddd; border-radius:10px; padding:12px; margin-bottom:12px; }
  button { padding:8px 12px; border-radius:8px; border:1px solid #ccc; cursor:pointer; }
  .mono { background:#fafafa; padding:8px; border-radius:6px; border:1px dashed #ddd; white-space:pre-wrap; }
  ul { margin:8px 0 0 20px; }
  ol { margin:8px 0 0 20px; }
  li { margin:6px 0; }
  #status { color:#007ACC; margin-top:8px; }
  .note { background:#fff7e6; border:1px solid #ffd27a; padding:10px; border-radius:8px; }
</style>
</head>
<body>
  <h1>初期設定マニュアル</h1>

  <div class="card">
    <h2>1. 権限付与</h2>
    <p>このアプリはシートの読み書き・メール送信・外部通信などを自動で行います。安全に動作させるため、最初に権限付与が必要です。Googleの認可画面でアクセスを許可してください。</p>
    <button onclick="grant()">権限を付与する</button>
  </div>

  <div class="card">
    <h2>2. トリガー設定</h2>
    <p>トリガーは処理の自動実行スケジュールです。例：<code>generateCompletionList</code> を毎時実行して回収完了リストを最新化します。必要に応じて作成・確認・削除してください。</p>
    <button onclick="create()">トリガー自動作成</button>
    <button onclick="show()">トリガー一覧</button>
    <button onclick="wipe()">すべて削除</button>
    <div id="trigs" class="mono" style="margin-top:8px;"></div>
  </div>

  <div class="card">
    <h2>3. 基本設定・手数料設定</h2>
    <ul>
      <li>基本設定：A〜M列のうち1〜11列を列単位で編集できます（12・13列は手数料設定で管理）。</li>
      <li>手数料設定：M〜O列（販売場所名・手数料率・有効フラグ）を編集できます。</li>
    </ul>
  </div>

  <div class="card">
    <h2>4. 回収完了 → 配付用リストの使い方</h2>

    <ol>
      <li><b>回収条件を設定</b><br>まず <code>回収完了</code> シートの「出品から何日経過」と「仕入れIDに対して何%回収済み」を設定します。</li>

      <li><b>回収完了リストを更新</b><br>設定ができたら、メニューバーの <code>管理メニュー</code> → <code>回収完了リストを更新</code> を押します。該当する商品が一覧で表示されます。</li>

      <li><b>確認チェック → フィルタで抽出</b><br>一覧で表示された商品の <b>A列「確認」チェックボックス</b> に、対象商品だけチェックを入れます。<br>その後、シート上の <code>フィルタ</code> ボタンを押すと、チェックが入ったものだけが一覧表示されます。</li>

      <li><b>販売情報を入力（M〜Q列）</b><br>抽出された行に対して、以下を入力していきます。<br>
        <ul>
          <li><b>M列：</b>販売日</li>
          <li><b>N列：</b>販売場所</li>
          <li><b>O列：</b>販売価格</li>
          <li><b>P列：</b>あらり</li>
          <li><b>Q列：</b>まとめID</li>
        </ul>
        BASEやジモティ等で売った商品金額を入力します。</li>

      <li><b>まとめ売りの入力ルール（販売価格の割り振り）</b><br>まとめ売りの商品は、まとめに含まれる商品数ぶんチェックして抽出しているはずです。<br>例：10点をBASEで <b>合計10,000円</b> で販売した場合、10行それぞれの <b>販売価格(O列)</b> は <b>1,000円</b> ずつ（1000,1000,1000...）のように入力します。</li>

      <li><b>入金額の考え方</b><br>各プラットフォームの手数料などがあるため、<b>手数料・送料などを差し引いた後の金額</b>を入れてください。</li>

      <li><b>まとめIDの付け方</b><br><code>まとめID</code> は、年月＋連番で付けます（Q列の上に例があります）。<br>
        例：<b>2025年12月</b> に作られたまとめなら <b>2512</b>、受注が1回目なら <b>01</b> を付けて <b>2512-01</b> のようにします。<br>
        2回目なら <b>02</b>、3回目なら <b>03</b> と連番を進めます。</li>

      <li><b>配付用リストを作成（チェック表/CSV用）</b><br>入力ができたら、メニューバーの <code>管理メニュー</code> → <code>2番 配付用リスト作成、チェック料を印刷、CSV用</code> を押します。<br>
        すると <code>配付用リスト</code> シートにデータが飛びます。</li>

      <li><b>配付用リストの用途（重要）</b><br><code>配付用リスト</code> は、<b>お客様にCSVとして提供するもの</b>であり、同時に<b>まとめ商品を梱包する方のチェック表</b>でもあります。<br>間違えないように注意してください。</li>

      <li><b>梱包担当：印刷手順</b><br>梱包する方は <code>配付用リスト</code> で該当する場所のセルを選択し、左上のメニュー <code>ファイル</code> → <code>印刷</code> を押して印刷してください。</li>

      <li><b>CSV配付：ダウンロード手順</b><br>配付用のCSVは、メニュー <code>ファイル</code> → <code>ダウンロード</code> → <code>カンマ区切り形式(.csv)</code> を選んでダウンロードします。<br>
        その後のやり方は、<code>回収完了</code> の <b>H2「CSV貼付ドライブ先」</b> と、<b>H列1「まとめ売り販売時に見るべきマニュアル」</b> を確認してください。</li>

      <li><b>梱包完了後：売却反映の一括処理</b><br>商品が梱包し終わったら、その商品は完了となります。<br>
        <code>回収完了</code> に戻り、メニューバーの <code>管理メニュー</code> → <code>3番 売却反映 確保チェック業を一括処理</code> を押します。<br>
        先ほど入力したデータが、商品管理（梱包元の管理しているところ）に反映されて終了です。</li>
    </ol>

    <div class="note" style="margin-top:10px;">
      <b>注意</b><br>
      配付用リストは「お客様用CSV」と「梱包チェック表」を兼ねています。チェック・抽出・入力の順番を必ず守り、入力ミスがない状態で作成してください。
    </div>
  </div>

  <p id="status"></p>

<script>
function setStatus(msg){ document.getElementById('status').textContent = msg || ''; }
function grant(){ setStatus('処理中...'); google.script.run.withSuccessHandler(function(){ setStatus('権限を付与しました'); setTimeout(function(){ setStatus(''); },3000); }).warmUp(); }
function create(){ setStatus('処理中...'); google.script.run.withSuccessHandler(function(list){ render(list); setStatus('トリガーを作成しました'); setTimeout(function(){ setStatus(''); },3000); }).createDefaultTriggers(); }
function show(){ setStatus('読み込み中...'); google.script.run.withSuccessHandler(function(list){ render(list); setStatus(''); }).listTriggers(); }
function wipe(){ if(!confirm('すべてのプロジェクトトリガーを削除します。よろしいですか？')) return; setStatus('処理中...'); google.script.run.withSuccessHandler(function(list){ render(list); setStatus('削除しました'); setTimeout(function(){ setStatus(''); },3000); }).deleteAllProjectTriggers(); }
function render(list){ const el=document.getElementById('trigs'); if(!list||!list.length){ el.textContent='なし'; return; } el.textContent=list.map(x=>x.func+' / '+x.type).join('\n'); }
</script>
</body>
</html>
