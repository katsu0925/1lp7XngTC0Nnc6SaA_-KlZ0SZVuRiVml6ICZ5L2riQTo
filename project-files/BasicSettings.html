<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>基本設定</title>
<style>
  body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;padding:16px;}
  h1{font-size:18px;margin:0 0 12px;}
  table{border-collapse:collapse;width:100%;}
  th,td{border:1px solid #ddd;padding:6px;}
  th{background:#f7f7f7;}
  input[type="text"]{width:100%;box-sizing:border-box;}
  .row{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap}
  button{padding:8px 12px;border:1px solid #ccc;border-radius:8px;cursor:pointer;}
  #status{color:#007ACC;margin-top:8px;}
  .grid{display:grid;grid-template-columns:60px 1fr 70px;gap:6px;align-items:center}
  .muted{opacity:.7}
</style>
</head>
<body>
  <h1>基本設定（A〜M列のうち1〜11列）</h1>

  <h2 class="muted" style="font-size:14px;margin:8px 0">1. 編集したい列を選択</h2>
  <table id="headers">
    <thead><tr><th>#</th><th>ヘッダー名</th><th>編集</th></tr></thead>
    <tbody></tbody>
  </table>

  <div id="editor" style="margin-top:16px;display:none">
    <h2 class="muted" style="font-size:14px;margin:8px 0">2. 列内容を編集</h2>
    <div class="row">
      <div style="min-width:220px;flex:1">
        <label>ヘッダー名</label>
        <input type="text" id="colHeader">
      </div>
      <div style="display:flex;gap:8px;align-items:flex-end">
        <button id="addRowBtn" onclick="addRow()">行を追加</button>
        <button id="saveBtn" onclick="save()">保存</button>
      </div>
    </div>

    <div id="rows" class="grid" style="margin-top:12px">
      <div><b>#</b></div><div><b>値</b></div><div><b>削除</b></div>
    </div>
  </div>

  <p id="status"></p>

<script>
let selectedIndex = null;
let currentValues = [];
let colMap = [];

function setStatus(msg){ document.getElementById('status').textContent = msg || ''; }

function disableAll(disabled){
  document.querySelectorAll('button, input').forEach(el=>{
    if(el.id==='colHeader' || el.closest('#editor')) el.disabled = disabled;
  });
}

function loadHeaders(){
  setStatus('読み込み中...');
  google.script.run.withSuccessHandler(function(headers){
    const tbody=document.querySelector('#headers tbody');
    tbody.innerHTML='';
    colMap = [];
    headers.forEach((h,i)=>{
      const colNumber = i+1;
      if(colNumber<=11){
        colMap.push(colNumber);
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${colNumber}</td><td>${h||''}</td><td><button onclick="openEditor(${colMap.length})">開く</button></td>`;
        tbody.appendChild(tr);
      }
    });
    setStatus('');
  }).getBasicHeaders();
}

function openEditor(displayIndex){
  const realColIndex = colMap[displayIndex-1];
  selectedIndex = realColIndex;
  setStatus('読み込み中...');
  disableAll(true);
  google.script.run.withSuccessHandler(function(payload){
    currentValues = (payload.values || []).filter(v => String(v).trim() !== '');
    document.getElementById('colHeader').value = payload.header || '';
    const container = document.getElementById('rows');
    container.innerHTML = '<div><b>#</b></div><div><b>値</b></div><div><b>削除</b></div>';

    if(currentValues.length===0){ appendRowElement(1,''); }
    else { currentValues.forEach((v,i)=>appendRowElement(i+1, v)); }

    document.getElementById('editor').style.display='block';

    setStatus('');
    disableAll(false);

    const firstVal = container.querySelector('input[type="text"]');
    if(firstVal){ firstVal.focus(); firstVal.select(); }
    else {
      const hdr = document.getElementById('colHeader');
      hdr.focus(); hdr.select();
    }
  }).getColumnData(realColIndex);
}

function appendRowElement(no, value){
  const container = document.getElementById('rows');
  const num = document.createElement('div');
  num.className='row-no';
  num.textContent = no;

  const inputWrap = document.createElement('div');
  const input = document.createElement('input');
  input.type='text';
  input.value = value || '';
  inputWrap.appendChild(input);

  const del = document.createElement('div');
  const btn = document.createElement('button');
  btn.textContent='✕';
  btn.onclick = function(){
    num.remove(); inputWrap.remove(); del.remove(); renumber();
  };
  del.appendChild(btn);

  container.appendChild(num);
  container.appendChild(inputWrap);
  container.appendChild(del);
}

function renumber(){
  const container = document.getElementById('rows');
  const cells = container.children;
  let idx = 0;
  for(let i=3;i<cells.length;i+=3){
    cells[i].textContent = (++idx);
  }
  if(idx===0) appendRowElement(1,'');
}

function addRow(){
  const container = document.getElementById('rows');
  const countDataRows = (container.children.length / 3) - 1;
  appendRowElement(countDataRows + 1, '');
}

function collectValues(){
  const inputs = document.querySelectorAll('#rows input[type="text"]');
  const vals = Array.from(inputs).map(i=>i.value).filter(v=>String(v).trim()!=='');
  return vals;
}

function save(){
  if(selectedIndex==null) return;
  const header = document.getElementById('colHeader').value;
  const values = collectValues();
  setStatus('保存中...');
  disableAll(true);
  google.script.run.withSuccessHandler(function(){
    setStatus('保存しました');
    setTimeout(function(){ setStatus(''); }, 3000);
    loadHeaders();
    disableAll(false);
  }).saveColumn(selectedIndex, header, values);
}

loadHeaders();
</script>
</body>
</html>